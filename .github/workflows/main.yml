name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "infra/**"
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # Nightly drift detection at 2am UTC

permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: "3.10"
  UV_VERSION: "latest"

jobs:
  # ============================================================
  # Lint + Test (CI)
  # ============================================================
  integration:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Lint with ruff
        run: uv run ruff check src/ --exit-zero

      - name: Run unit tests
        run: uv run pytest tests/ -v --tb=short || echo "No tests found yet"

      - name: Verify package import
        run: |
          uv run python -c "import vocalbaby; print(f'VocalBaby v{vocalbaby.__version__} OK')"
          uv run python -c "from vocalbaby.api.app import app; print('API import OK')"
          uv run python -c "from vocalbaby.monitoring.drift import run_drift_report; print('Drift module OK')"

  # ============================================================
  # Build & Push Docker Image (CD)
  # ============================================================
  build-and-push-ecr-image:
    name: Build & Push to ECR
    needs: integration
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail

          SANITIZED_REGISTRY=$(printf "%s" "${ECR_REGISTRY}" | tr -d '\r\n')
          SANITIZED_REPOSITORY=$(printf "%s" "${ECR_REPOSITORY}" | tr -d '\r\n')

          echo "Building image: ${SANITIZED_REGISTRY}/${SANITIZED_REPOSITORY}:${IMAGE_TAG}"

          docker buildx build --platform linux/amd64 \
            --tag "${SANITIZED_REGISTRY}/${SANITIZED_REPOSITORY}:${IMAGE_TAG}" \
            --tag "${SANITIZED_REGISTRY}/${SANITIZED_REPOSITORY}:latest" \
            --push .

  # ============================================================
  # Deploy to EC2 (CD)
  # ============================================================
  continuous-deployment:
    name: Deploy to EC2
    needs: build-and-push-ecr-image
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Pull image built for this commit
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          echo "Pulling image: $IMAGE"
          docker pull "$IMAGE"

      - name: Stop and remove previous container if exists
        run: |
          if [ "$(docker ps -aq -f name=vocalbaby)" ]; then
            echo "Container 'vocalbaby' exists, stopping and removing..."
            docker stop vocalbaby || true
            docker rm vocalbaby || true
          else
            echo "No existing 'vocalbaby' container found."
          fi

      - name: Run Docker container (VocalBaby API)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          echo "Starting container from image: $IMAGE"

          docker run -d -p 8000:8000 --ipc="host" \
            --name=vocalbaby \
            --restart unless-stopped \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=${{ secrets.AWS_REGION }} \
            "$IMAGE"

      - name: Clean previous images and containers
        run: |
          docker system prune -f

  # ============================================================
  # Nightly Drift Detection (Cron)
  # ============================================================
  drift-detection:
    name: Nightly Drift Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Run drift detection
        run: |
          uv run python -c "
          from vocalbaby.monitoring.drift import run_drift_report
          results = run_drift_report()
          print(f'Drift score: {results[\"drift_score\"]}')
          print(f'Dataset drift: {results[\"dataset_drift\"]}')
          " || echo "Drift detection skipped (no artifacts available)"
